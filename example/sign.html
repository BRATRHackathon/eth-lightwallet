<html>
<head>
  <title>Thomson Reuters - Terms and conditions acceptance system.</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
  <script src="../dist/lightwallet.min.js"></script>
  <script type="text/javascript" src="../node_modules/web3/dist/web3.js"></script>
  <script type="text/javascript" src="../node_modules/hooked-web3-provider/build/hooked-web3-provider.js"></script>
  <script type="text/javascript" src="../node_modules/async/lib/async.js"></script>

  <script>        
    var web3 = new Web3();
    var global_keystore;
    var abi = [{ "constant": true, "inputs": [], "name": "GetRequiredSubscribers", "outputs": [{ "name": "", "type": "address[]" }], "payable": false, "type": "function" }, { "constant": false, "inputs": [{ "name": "newOwner", "type": "address" }], "name": "SetOwner", "outputs": [], "payable": false, "type": "function" }, { "constant": false, "inputs": [{ "name": "member", "type": "address" }], "name": "AddSubscriber", "outputs": [], "payable": false, "type": "function" }, { "constant": true, "inputs": [], "name": "ReadContent", "outputs": [{ "name": "", "type": "bytes" }], "payable": false, "type": "function" }, { "constant": false, "inputs": [], "name": "Sign", "outputs": [], "payable": false, "type": "function" }, { "constant": true, "inputs": [], "name": "GetSignedSubscribers", "outputs": [{ "name": "", "type": "address[]" }], "payable": false, "type": "function" }, { "constant": false, "inputs": [{ "name": "members", "type": "address[]" }], "name": "AddSubscribers", "outputs": [], "payable": false, "type": "function" }, { "constant": false, "inputs": [{ "name": "member", "type": "address" }], "name": "RemoveSubscriber", "outputs": [], "payable": false, "type": "function" }, { "inputs": [{ "name": "blob", "type": "bytes" }, { "name": "parts", "type": "address[]" }], "payable": false, "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "message", "type": "string" }], "name": "SendMessage", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "subscribers", "type": "address[]" }], "name": "Create", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "signer", "type": "address" }, { "indexed": false, "name": "timestamp", "type": "uint256" }], "name": "Signed", "type": "event" }];

    function setWeb3Provider(keystore) {
      var web3Provider = new HookedWeb3Provider({
        host: "http://localhost:8545",
        transaction_signer: keystore
      });

      web3.setProvider(web3Provider);
    }

    function newAddresses(password) {
      if (password == '') {
        password = prompt('Enter password to retrieve addresses', 'Password');
      }
      lightwallet.keystore.deriveKeyFromPassword(password, function (err, pwDerivedKey) {
        global_keystore.generateNewAddress(pwDerivedKey, 1);

        var addresses = global_keystore.getAddresses();

        document.getElementById('sendFrom').innerHTML = ''
        document.getElementById('functionCaller').innerHTML = ''
        for (var i = 0; i < addresses.length; ++i) {
          document.getElementById('sendFrom').innerHTML += '<option value="' + addresses[i] + '">' + addresses[i] + '</option>'
          document.getElementById('functionCaller').innerHTML += '<option value="' + addresses[i] + '">' + addresses[i] + '</option>'
        }

        getBalances();
      })
    }

    function getBalances() {

      var addresses = global_keystore.getAddresses();
      document.getElementById('addr').innerHTML = 'Retrieving addresses...'

      async.map(addresses, web3.eth.getBalance, function (err, balances) {
        async.map(addresses, web3.eth.getTransactionCount, function (err, nonces) {
          document.getElementById('addr').innerHTML = ''
          for (var i = 0; i < addresses.length; ++i) {
            document.getElementById('addr').innerHTML += '<div>' + addresses[i] + ' (Bal: ' + (balances[i] / 1.0e18) + ' ETH, Nonce: ' + nonces[i] + ')' + '</div>'
          }
        })
      })

    }

    function loadId() {
      var inptseed = document.getElementById('seed');
      var id = inptseed.value;
      if (id.length == 0) return;

      var password = prompt('Enter Password to load your identity', 'Password');

      lightwallet.keystore.deriveKeyFromPassword(password, function (err, pwDerivedKey) {
        global_keystore = new lightwallet.keystore(
          id,
          pwDerivedKey);

        global_keystore.generateNewAddress(pwDerivedKey, 1);
        inptseed.value = ''
        inptseed.style.display = 'none';

        setWeb3Provider(global_keystore);

        //getBalances();
        document.getElementById('address1').innerText = global_keystore.getAddresses()[0];
      })
    }

    String.prototype.hexDecode = function () {
      var hexx = this;
      var hex = hexx.toString();//force conversion
      var str = '';
      for (var i = 0; i < hex.length; i += 2)
        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
        var toRet = "";
        try 
        {
          toRet = decodeURIComponent(escape(str));
        } catch (e) {
          toRet = str;
        }
      return str;
    }

    function loadContract() {
      var contractAddr = document.getElementById('contractAddr').value;

      if (contractAddr.indexOf('0x') == -1) contractAddr = '0x' + contractAddr;

      if (contractAddr.length != 42) return;

      document.getElementById('contractAddr').value = contractAddr;

      var contract = web3.eth.contract(abi).at(contractAddr);

      var gasPrice = 50000000000
      var gas = 3141592
      var fromAddr = global_keystore.getAddresses()[0];

      contract.ReadContent({ from: fromAddr, value: 0, gasPrice: gasPrice, gas: gas }, function (err, result) {
        var tarea = document.getElementById('contractText');
        tarea.innerHTML = result.hexDecode().replace(/\r\n|\r|\n/g,"</p><p>");
        tarea.style.display = 'block';
      });
    }

    function SignIt() {
      var fromAddr = global_keystore.getAddresses()[0];
      var contractAddr = document.getElementById('contractAddr').value;
      var contract = web3.eth.contract(abi).at(contractAddr);
      var block = web3.eth.getBlock('latest').number;

      var event = contract.SendMessage(null, { fromBlock: 0, toBlock: 'latest' })
      event.watch(function (err, result) {
        if (typeof(result) !== 'undefined' && result.blockNumber > block) {
          event.stopWatching();
          if (!err)
            document.getElementById('receipt').innerText = document.getElementById('receipt').innerText +
              " (" + result.args["message"] + ")";
          else
            document.getElementById('receipt').innerText = document.getElementById('receipt').innerText +
              " (" + err + ")";
        }
      });
      var functionName = "Sign";

      var args = [];
      var gasPrice = 50000000000
      var gas = 3141592
      args.push({ from: fromAddr, value: 0, gasPrice: gasPrice, gas: gas })
      var callback = function (err, txhash) {
        console.log('error: ' + err)
        console.log('txhash: ' + txhash)
        document.getElementById('receipt').innerText = txhash;
      }
      args.push(callback)
      contract[functionName].apply(this, args)
    }

  </script>  
  <nav class="navbar navbar-inverse"><div class="navbar-header">Thomson Reuters </div></nav>
<div class="container">
  <h2>Your ID</h2>
  <div class="row">
    <div class="col-sm-2"><label for="id">  Your Identity Signature: </label></div>
    <div class="col-sm-6"><input type="text" name="id" id="seed" value="" size="80" onblur="loadId()"/><div id="address1"></div></div>
  </div>

  <h2>Contract Data</h2>
  <div class="row">
    <div class="col-sm-2"><label for="id">  Contract Address: </label></div>
    <div class="col-sm-6"><input type="text" size="80" id="contractAddr" onblur="loadContract()"></input></div>
  </div>
  
    
    <blockquote>
      <p id="contractText" readonly style="display:none"></p>
    </blockquote>

  <h2> Signature </h2>
  <div class="row">
    <div class="col-sm-4"><button onclick="SignIt()">By clicking this button, I agree with those terms.</button></div>
    <div class="col-sm-8"><div id="receipt"></div></input></div>
  </div>
  <br><br>
</body>

</html>